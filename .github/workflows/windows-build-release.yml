name: Windows Build and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up MSVC (VS 2022)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # Minimal, reliable vcpkg setup (replaces the broken actions/setup-vcpkg)
      - name: Set up vcpkg
        uses: johnwason/setup-vcpkg@v1
        with:
          # Optionally pin a known-good vcpkg commit/ref
          # vcpkgGitRef: '2024.08.23'
          disableMetrics: true

      # If your repo uses vcpkg manifest (vcpkg.json), CMake will auto-use it when toolchain is set.
      - name: Configure (CMake + vcpkg toolchain)
        shell: pwsh
        run: >
          cmake -S . -B build
          -DCMAKE_TOOLCHAIN_FILE="${env:VCPKG_ROOT}\scripts\buildsystems\vcpkg.cmake"
          -DCMAKE_BUILD_TYPE=Release

      - name: Build
        shell: pwsh
        run: cmake --build build --config Release

      - name: Install/Package
        if: success()
        shell: pwsh
        run: cmake --install build --config Release --prefix "$env:RUNNER_TEMP\dist"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: ${{ runner.temp }}\dist
